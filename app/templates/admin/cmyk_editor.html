{% extends "sqladmin/layout.html" %}

{% block content_header %}
<div class="row align-items-center">
  <div class="col">
    <h2 class="page-title">CMYK Editor</h2>
    <div class="page-pretitle">Visual attribute editor for Ghost characters</div>
  </div>
</div>
{% endblock %}

{% block content %}
<!-- Game selector -->
<div class="col-12">
  <div class="card">
    <div class="card-body">
      <form method="get" action="/admin/cmyk-editor" class="row g-3 align-items-end">
        <div class="col-auto">
          <label class="form-label">Select Game</label>
          <select name="game_id" class="form-select" onchange="this.form.submit()">
            <option value="">-- Select a game --</option>
            {% for game in games %}
            <option value="{{ game.id }}" {% if game.id == game_id %}selected{% endif %}>
              {{ game.name }}
            </option>
            {% endfor %}
          </select>
        </div>
      </form>
    </div>
  </div>
</div>

{% if game_id and ghosts %}
{% for ghost in ghosts %}
<div class="col-lg-6">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="fa-solid fa-ghost me-2"></i>{{ ghost.name }}
      </h3>
    </div>
    <div class="card-body">
      <form method="post" action="/admin/cmyk-editor/save">
        <input type="hidden" name="ghost_id" value="{{ ghost.id }}">
        <input type="hidden" name="game_id" value="{{ game_id }}">

        <!-- Color preview -->
        <div class="mb-3 text-center">
          <div id="preview-{{ ghost.id }}"
               style="width: 100%; height: 60px; border-radius: 8px; border: 1px solid #dee2e6;
                      background-color: rgb({{ 255 * (1 - ghost.cmyk.C / 10) * (1 - ghost.cmyk.K / 10) | int }}, {{ 255 * (1 - ghost.cmyk.M / 10) * (1 - ghost.cmyk.K / 10) | int }}, {{ 255 * (1 - ghost.cmyk.Y / 10) * (1 - ghost.cmyk.K / 10) | int }});">
          </div>
        </div>

        <!-- CMYK sliders -->
        {% set colors = [
          ('C', 'Cyan', '#00BCD4', ghost.cmyk.C),
          ('M', 'Magenta', '#E91E63', ghost.cmyk.M),
          ('Y', 'Yellow', '#FFC107', ghost.cmyk.Y),
          ('K', 'Black', '#424242', ghost.cmyk.K)
        ] %}
        {% for key, label, color, value in colors %}
        <div class="mb-2">
          <label class="form-label d-flex justify-content-between">
            <span style="color: {{ color }}; font-weight: bold;">{{ label }} ({{ key }})</span>
            <span id="val-{{ ghost.id }}-{{ key }}">{{ value }}</span>
          </label>
          <input type="range" class="form-range" name="{{ key }}" min="0" max="10" value="{{ value }}"
                 oninput="updateCMYK('{{ ghost.id }}')">
        </div>
        {% endfor %}

        <!-- HP bar -->
        <div class="mb-3">
          <label class="form-label">HP: {{ ghost.hp }} / {{ ghost.hp_max }}</label>
          <div class="progress">
            {% set hp_pct = (ghost.hp / ghost.hp_max * 100) if ghost.hp_max > 0 else 0 %}
            <div class="progress-bar {% if hp_pct > 50 %}bg-green{% elif hp_pct > 25 %}bg-yellow{% else %}bg-red{% endif %}"
                 style="width: {{ hp_pct }}%">
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">Save CMYK</button>
      </form>
    </div>
  </div>
</div>
{% endfor %}

{% elif game_id and not ghosts %}
<div class="col-12">
  <div class="card">
    <div class="card-body text-center text-muted">
      No ghosts found in this game.
    </div>
  </div>
</div>
{% endif %}

<script>
function updateCMYK(ghostId) {
  const form = document.querySelector(`input[value="${ghostId}"]`).closest('form');
  const c = parseInt(form.querySelector('input[name="C"]').value);
  const m = parseInt(form.querySelector('input[name="M"]').value);
  const y = parseInt(form.querySelector('input[name="Y"]').value);
  const k = parseInt(form.querySelector('input[name="K"]').value);

  // Update value labels
  document.getElementById(`val-${ghostId}-C`).textContent = c;
  document.getElementById(`val-${ghostId}-M`).textContent = m;
  document.getElementById(`val-${ghostId}-Y`).textContent = y;
  document.getElementById(`val-${ghostId}-K`).textContent = k;

  // CMYK to RGB conversion
  const r = Math.round(255 * (1 - c / 10) * (1 - k / 10));
  const g = Math.round(255 * (1 - m / 10) * (1 - k / 10));
  const b = Math.round(255 * (1 - y / 10) * (1 - k / 10));

  document.getElementById(`preview-${ghostId}`).style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
}
</script>
{% endblock %}
