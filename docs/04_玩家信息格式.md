# 04 — 玩家信息格式

> 本文档定义 dg-engine 中玩家、褪色症患者、电子幽灵的数据结构，
> 以及 CMYK 属性系统、打印能力、量子活性等核心机制的数据格式规范。

---

## 1. 概念分层

电子幽灵的玩家数据分为三个层次：

```
┌─────────────────────────────────────────────────────┐
│  Player（账号层）                                      │
│  ─ 关联平台身份（Discord / QQ / Web）                   │
│  ─ 一个 Player 可拥有多个 Patient                       │
│                                                     │
│  ┌─────────────────────────────────────────────────┐ │
│  │  Patient（褪色症患者）                              │ │
│  │  ─ 公开层：名片信息                                 │ │
│  │  ─ 保密层：灵魂底色、人格档案、CMYK 属性              │ │
│  │                                                 │ │
│  │  ┌───────────────────────────────────────────┐   │ │
│  │  │  Ghost（电子幽灵）                          │   │ │
│  │  │  ─ 由另一位玩家创造                          │   │ │
│  │  │  ─ 与 Patient 一对一绑定                     │   │ │
│  │  │  ─ 持有打印能力                              │   │ │
│  │  └───────────────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

---

## 2. Player —— 账号层

Player 是纯粹的身份标识，不包含任何游戏内数据。

### 2.1 数据结构

```python
class PlayerSchema(BaseModel):
    """玩家账号"""
    id: str                         # 内部唯一 ID
    platform: str                   # 平台标识: "discord" | "qq" | "web"
    platform_user_id: str           # 平台用户 ID
    display_name: str               # 显示名称
    created_at: datetime
```

### 2.2 设计要点

| 要点 | 说明 |
|------|------|
| 一个玩家可参与多个 Session | 通过 `session_players` 关联 |
| 一个玩家可拥有多个 Patient | 不同 Session 中可使用不同角色 |
| Player 不持有游戏状态 | 所有游戏状态在 Patient / Ghost 上 |

---

## 3. Patient —— 褪色症患者

Patient 是玩家在灰山城中的角色实体，分为**公开层**和**保密层**。

### 3.1 公开层（Public Layer）

公开层信息对所有玩家可见，相当于"患者大厅的社交名片"。

```python
class PatientPublicSchema(BaseModel):
    """患者公开信息"""
    id: str
    name: str                       # 角色名
    gender: str | None              # 性别
    age: int | None                 # 年龄
    former_identity: str | None     # 原社会身份
    appearance: str | None          # 外貌描述 / 立绘描述
    quantum_activity: int           # 当前量子活性（HP）
    quantum_activity_max: int       # 量子活性上限
```

### 3.2 保密层（Secret Layer）

保密层信息仅玩家本人和 DM 可见，通过【通信】可选择性地向他人公开。

```python
class PatientSecretSchema(BaseModel):
    """患者保密信息"""
    base_color: str                 # 灵魂底色: "C" | "M" | "Y" | "K"
    cmyk_attributes: CMYKAttributes # CMYK 四色属性
    personality_files: dict         # 人格档案
    ideal_projection: str | None    # 理想投射
```

### 3.3 完整数据结构

```python
class PatientFullSchema(BaseModel):
    """患者完整信息（公开层 + 保密层）"""
    # 公开层
    id: str
    player_id: str
    name: str
    gender: str | None
    age: int | None
    former_identity: str | None
    appearance: str | None
    quantum_activity: int
    quantum_activity_max: int

    # 保密层
    base_color: str
    cmyk_attributes: CMYKAttributes
    personality_files: PersonalityFiles
    ideal_projection: str | None

    # 关联
    ghost: GhostSchema | None       # 当前伴随的电子幽灵
    print_abilities: list[PrintAbilitySchema]  # 通过通信获得的能力

    created_at: datetime
    updated_at: datetime
```

---

## 4. Ghost —— 电子幽灵

Ghost 是由另一位玩家创造的伙伴实体，与 Patient 一对一绑定。

### 4.1 核心设计

| 特性 | 说明 |
|------|------|
| 创造者 | 另一位玩家（`creator_player_id`），基于 SWAP 文件创造 |
| 绑定关系 | 与 Patient 一对一（`patient_id`），但 Ghost 不一定属于该 Patient |
| 能力持有 | Ghost 天生持有一个打印能力（由创造者设计） |
| 独立性格 | Ghost 有独立的性格描述，通常是底色的极端化体现 |

### 4.2 数据结构

```python
class GhostSchema(BaseModel):
    """电子幽灵"""
    id: str
    patient_id: str                 # 当前宿主患者 ID
    creator_player_id: str          # 创造者玩家 ID

    # 公开层
    name: str                       # 幽灵名称
    appearance: str | None          # 外貌描述
    personality: str | None         # 性格描述

    # 颜色
    base_color: str                 # 底色（继承自患者）

    # 能力
    print_abilities: list[PrintAbilitySchema]  # 幽灵的打印能力

    created_at: datetime
    updated_at: datetime
```

### 4.3 Ghost 与 Patient 的关系规则

```
玩家 A 创建 Patient_A（底色: C）
    → 系统生成 SWAP 文件，发给 玩家 B
    → 玩家 B 基于 SWAP 创造 Ghost_for_A
    → Ghost_for_A 绑定到 Patient_A

玩家 B 创建 Patient_B（底色: M）
    → 系统生成 SWAP 文件，发给 玩家 C
    → 玩家 C 基于 SWAP 创造 Ghost_for_B
    → Ghost_for_B 绑定到 Patient_B

核心悬念：Ghost_for_A 可能才是 Patient_A 真正的"分身"
         Patient_A 需要通过【通信】比对数据来寻找自己的幽灵
```

---

## 5. CMYK 属性系统

### 5.1 四色属性定义

| 颜色代码 | 名称 | 人格信道 | 对应情绪 | 骰子关联 |
|---------|------|---------|---------|---------|
| `C` | Cyan（蓝） | Cognition（认知） | 忧郁 | 蓝色检定掷 C 值个骰子 |
| `M` | Magenta（红） | Might（力量） | 愤怒 | 红色检定掷 M 值个骰子 |
| `Y` | Yellow（黄） | harmonY（和谐） | 高兴 | 黄色检定掷 Y 值个骰子 |
| `K` | Key（黑） | Keystone（意志） | 痛苦 | 黑色检定掷 K 值个骰子 |

### 5.2 属性数据结构

```python
class CMYKAttribute(BaseModel):
    """单个颜色属性"""
    color: str                      # "C" | "M" | "Y" | "K"
    value: int                      # 当前值（= 可投掷的骰子数量）
    print_ability_count: int        # 该颜色下已获得的打印能力数量


class CMYKAttributes(BaseModel):
    """CMYK 四色属性集合"""
    C: CMYKAttribute = CMYKAttribute(color="C", value=1, print_ability_count=0)
    M: CMYKAttribute = CMYKAttribute(color="M", value=1, print_ability_count=0)
    Y: CMYKAttribute = CMYKAttribute(color="Y", value=1, print_ability_count=0)
    K: CMYKAttribute = CMYKAttribute(color="K", value=1, print_ability_count=0)

    def get(self, color: str) -> CMYKAttribute:
        """通过颜色代码获取属性"""
        return getattr(self, color)

    def total_dice(self) -> int:
        """总骰子数"""
        return self.C.value + self.M.value + self.Y.value + self.K.value
```

### 5.3 属性值规则

| 规则 | 说明 |
|------|------|
| 初始值 | 底色属性为 1，其余三色为 1 |
| 提升方式 | 收集对应颜色碎片（`ColorFragment`）→ 消耗碎片提升属性 |
| 上限 | 单色属性上限为 5（可在配置中调整） |
| 骰子对应 | 属性值 N = 检定时投 N 个 d6 |

### 5.4 属性与机制关联

```
CMYK 属性值
    ├── 技能检定 → 投掷 value 个 d6
    ├── 通信资格 → 拥有某颜色属性（value >= 1）才能与同色玩家通信
    ├── 打印能力 → 通过通信下载对方的打印能力
    └── 幽灵进化 → 四色补完后幽灵可进化为完全体
```

---

## 6. PrintAbility —— 打印能力

### 6.1 数据结构

```python
class PrintAbilitySchema(BaseModel):
    """打印能力"""
    id: str
    name: str                       # 能力名称（如"倒流的雨"）
    description: str                # 能力描述
    color: str                      # 关联颜色: "C" | "M" | "Y" | "K"
    effect_type: str                # 效果类型: attack / defense / control / recovery / special

    # 持有关系（二选一）
    patient_id: str | None          # 通过通信获得时，绑定到 Patient
    ghost_id: str | None            # 原生属于 Ghost


class PrintAbilityCreate(BaseModel):
    """创建打印能力"""
    name: str
    description: str
    color: str                      # "C" | "M" | "Y" | "K"
    effect_type: str                # attack / defense / control / recovery / special
```

### 6.2 颜色与效果类型对应

| 颜色 | 推荐效果类型 | 示例 |
|------|------------|------|
| C（蓝） | `control` | "时间断层" —— 冻结目标 3 秒内的所有数据流 |
| M（红） | `attack` | "倒流的雨" —— 将区域内所有水分子逆向加速 |
| Y（黄） | `recovery` | "共鸣回声" —— 将伤害转化为与目标的临时链接 |
| K（黑） | `defense` | "零点壁障" —— 在自身周围创建绝对静止领域 |

### 6.3 打印能力的游戏效果

| 效果 | 说明 |
|------|------|
| 重投机会 | 技能检定失败时，消耗一次打印能力使用次数，可重投骰子 |
| 每 Session 限制 | 每个打印能力每 Session 可使用的次数有限（默认 1 次） |
| 获取方式 | Ghost 原生持有 1 个；Patient 通过【通信】下载获得更多 |

---

## 7. Quantum Activity —— 量子活性（HP）

### 7.1 数据格式

```python
class QuantumActivity(BaseModel):
    """量子活性（HP）"""
    current: int                    # 当前值
    max: int                        # 上限值

    def is_alive(self) -> bool:
        return self.current > 0

    def take_damage(self, amount: int) -> int:
        """受到伤害，返回实际伤害值"""
        actual = min(amount, self.current)
        self.current -= actual
        return actual

    def heal(self, amount: int) -> int:
        """恢复活性，返回实际恢复值"""
        actual = min(amount, self.max - self.current)
        self.current += actual
        return actual
```

### 7.2 配置项

```python
# app/infra/config.py

class Settings(BaseSettings):
    QUANTUM_ACTIVITY_INITIAL: int = 10    # 初始量子活性
    QUANTUM_ACTIVITY_MAX: int = 10        # 量子活性上限
    QUANTUM_ACTIVITY_SECTOR_PENALTY: int = 3  # 无秘钥强行穿越扣除值
```

### 7.3 量子活性规则

| 情况 | 变化 |
|------|------|
| 初始创建 | 设为 `QUANTUM_ACTIVITY_INITIAL` |
| 战斗受伤 | 根据伤害值扣除 |
| 获取扇区秘钥 | 回满至 `max` |
| 无秘钥穿越 | 扣除 `QUANTUM_ACTIVITY_SECTOR_PENALTY` |
| 归零 | 触发【幽体坍缩】事件 |

---

## 8. 数据文件类型

角色创建完成后，系统生成三种不同权限的数据视图：

### 8.1 PUBLIC —— 社交名片

```python
class PatientFilePublic(BaseModel):
    """PUBLIC 文件 —— 患者大厅的社交名片"""
    file_type: Literal["PUBLIC"] = "PUBLIC"
    patient_id: str
    name: str
    gender: str | None
    age: int | None
    former_identity: str | None
    appearance: str | None
    quantum_activity: int
    quantum_activity_max: int
    ghost_name: str | None          # 伴随幽灵的名称
    ghost_appearance: str | None    # 伴随幽灵的外貌
```

### 8.2 FULL —— 完整档案

```python
class PatientFileFull(BaseModel):
    """FULL 文件 —— 完整数据，用于通信时交换秘密"""
    file_type: Literal["FULL"] = "FULL"
    patient_id: str

    # 公开层
    name: str
    gender: str | None
    age: int | None
    former_identity: str | None
    appearance: str | None
    quantum_activity: int
    quantum_activity_max: int

    # 保密层
    base_color: str
    cmyk_attributes: CMYKAttributes
    personality_files: dict         # 全部四色人格档案
    ideal_projection: str | None

    # 幽灵
    ghost: GhostSchema | None
    print_abilities: list[PrintAbilitySchema]
```

### 8.3 SWAP —— 残缺表格

```python
class PatientFileSwap(BaseModel):
    """SWAP 文件 —— 用于发给另一位玩家创造幽灵"""
    file_type: Literal["SWAP"] = "SWAP"
    patient_id: str

    base_color: str                 # 灵魂底色
    ideal_projection: str           # 理想投射
    single_personality_file: dict   # 仅含底色对应的单项人格档案
    # 例: base_color="C" → {"C": "蓝色档案的内容..."}
```

### 8.4 文件生成函数

```python
# app/domain/character.py

def generate_patient_file(patient: Patient, file_type: str) -> BaseModel:
    """根据文件类型生成不同权限的数据视图"""
    if file_type == "PUBLIC":
        return PatientFilePublic(
            patient_id=patient.id,
            name=patient.name,
            gender=patient.gender,
            age=patient.age,
            former_identity=patient.former_identity,
            appearance=patient.appearance,
            quantum_activity=patient.quantum_activity,
            quantum_activity_max=patient.quantum_activity_max,
            ghost_name=patient.ghost.name if patient.ghost else None,
            ghost_appearance=patient.ghost.appearance if patient.ghost else None,
        )
    elif file_type == "FULL":
        return PatientFileFull(
            patient_id=patient.id,
            name=patient.name,
            # ... 完整字段映射
        )
    elif file_type == "SWAP":
        color = patient.base_color
        return PatientFileSwap(
            patient_id=patient.id,
            base_color=color,
            ideal_projection=patient.ideal_projection,
            single_personality_file={
                color: patient.personality_files.get(color, "")
            },
        )
    else:
        raise ValueError(f"未知的文件类型: {file_type}")
```

---

## 9. 数据验证规则

### 9.1 创建时验证

```python
class PatientCreate(BaseModel):
    """创建患者请求"""
    player_id: str
    name: str = Field(min_length=1, max_length=64)
    gender: str | None = Field(None, max_length=16)
    age: int | None = Field(None, ge=0, le=999)
    former_identity: str | None = Field(None, max_length=128)
    appearance: str | None = None
    base_color: str = Field(pattern=r"^[CMYK]$")
    personality_files: dict = Field(default_factory=dict)
    ideal_projection: str | None = None


class GhostCreate(BaseModel):
    """创建幽灵请求"""
    patient_id: str
    creator_player_id: str
    name: str = Field(min_length=1, max_length=64)
    appearance: str | None = None
    personality: str | None = None
    base_color: str = Field(pattern=r"^[CMYK]$")
    print_ability: PrintAbilityCreate   # 创造时必须指定一个打印能力
```

### 9.2 颜色代码校验

```python
VALID_COLORS = {"C", "M", "Y", "K"}

def validate_color(color: str) -> str:
    if color not in VALID_COLORS:
        raise ValueError(f"无效的颜色代码: {color}，必须为 C/M/Y/K 之一")
    return color
```
